package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/parlia/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

const (
	punishV1Code = "0x608060405234801561001057600080fd5b506004361061016c5760003560e01c80638129fc1c116100cd578063e0d8ea5311610081578063ec0cb33611610066578063ec0cb336146101c1578063f3b1cc67146101c1578063f62af26c146102a457600080fd5b8063e0d8ea5314610289578063ea7221a11461029157600080fd5b8063c967f90f116100b2578063c967f90f14610252578063cb1ea7251461026d578063d93d2cb91461027657600080fd5b80638129fc1c1461023a5780639001eed81461024257600080fd5b806332f3c17f1161012457806344f999001161010957806344f99900146101fb57806363e1d4511461021c57806371a1bb751461023157600080fd5b806332f3c17f146101c957806344c1aa99146101f257600080fd5b806315de360e1161015557806315de360e146101b05780632897183d146101b85780632e4f67e4146101c157600080fd5b806303fab4f614610171578063158ef93e14610193575b600080fd5b610180670de0b6b3a764000081565b6040519081526020015b60405180910390f35b6000546101a09060ff1681565b604051901515815260200161018a565b610180600a81565b61018060035481565b610180601481565b6101806101d7366004610d18565b6001600160a01b031660009081526004602052604090205490565b61018060025481565b61020461c00381565b6040516001600160a01b03909116815260200161018a565b61022f61022a366004610d18565b6102b7565b005b61020461c00281565b61022f610592565b6101806802b5e3af16b188000081565b61025a600f81565b60405161ffff909116815260200161018a565b61018060015481565b61022f610284366004610d59565b610606565b600554610180565b61022f61029f366004610d18565b6108d5565b6102046102b2366004610d59565b610cee565b60005460ff166102fd5760405162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b60448201526064015b60405180910390fd5b60405163d86768e960e01b81526001600160a01b0382166004820152339061c0029063d86768e99060240160206040518083038186803b15801561034057600080fd5b505afa158015610354573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103789190610d3c565b6001600160a01b0316146103ce5760405162461bcd60e51b815260206004820152601860248201527f56616c696461746f72206e6f742072656769737465726564000000000000000060448201526064016102f4565b6001600160a01b03811660009081526004602052604090205415610406576001600160a01b0381166000908152600460205260408120555b6001600160a01b03811660009081526004602052604090206002015460ff168015610432575060055415155b1561058f5760055461044690600190610d86565b6001600160a01b0382166000908152600460205260409020600101541461052357600580546000919061047b90600190610d86565b8154811061048b5761048b610e0e565b60009182526020808320909101546001600160a01b03858116845260049092526040909220600101546005805492909316935083929181106104cf576104cf610e0e565b6000918252602080832091909101805473ffffffffffffffffffffffffffffffffffffffff19166001600160a01b039485161790558483168252600490526040808220600190810154949093168252902001555b600580548061053457610534610df8565b600082815260208082208301600019908101805473ffffffffffffffffffffffffffffffffffffffff191690559092019092556001600160a01b038316825260049052604081206001810191909155600201805460ff191690555b50565b60005460ff16156105e55760405162461bcd60e51b815260206004820152601360248201527f416c726561647920696e697469616c697a65640000000000000000000000000060448201526064016102f4565b6004600181815560086002556003919091556000805460ff19169091179055565b3341146106425760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016102f4565b4360009081526007602052604090205460ff16156106a25760405162461bcd60e51b815260206004820152601160248201527f416c72656164792064656372656173656400000000000000000000000000000060448201526064016102f4565b60005460ff166106e35760405162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b60448201526064016102f4565b806106ee8143610db8565b1561073b5760405162461bcd60e51b815260206004820152601060248201527f426c6f636b2065706f6368206f6e6c790000000000000000000000000000000060448201526064016102f4565b436000908152600760205260409020805460ff19166001179055600554610760575050565b60005b6005548110156108a75760035460025461077d9190610d72565b600460006005848154811061079457610794610e0e565b60009182526020808320909101546001600160a01b031683528201929092526040019020541115610856576003546002546107cf9190610d72565b60046000600584815481106107e6576107e6610e0e565b60009182526020808320909101546001600160a01b031683528201929092526040019020546108159190610d86565b600460006005848154811061082c5761082c610e0e565b60009182526020808320909101546001600160a01b03168352820192909252604001902055610895565b6000600460006005848154811061086f5761086f610e0e565b60009182526020808320909101546001600160a01b031683528201929092526040019020555b8061089f81610d9d565b915050610763565b506040517f181d51be54e8e8eaca6eae0eab32d4162099236bd519e7238d015d0870db464190600090a15050565b3341146109115760405162461bcd60e51b815260206004820152600a6024820152694d696e6572206f6e6c7960b01b60448201526064016102f4565b60005460ff166109525760405162461bcd60e51b815260206004820152600c60248201526b139bdd081a5b9a5d081e595d60a21b60448201526064016102f4565b4360009081526006602052604090205460ff16156109b25760405162461bcd60e51b815260206004820152601060248201527f416c72656164792070756e69736865640000000000000000000000000000000060448201526064016102f4565b436000908152600660209081526040808320805460ff191660011790556001600160a01b0384168352600490915290206002015460ff16610a6857600580546001600160a01b038316600081815260046020526040812060018082018590558085019095557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0909301805473ffffffffffffffffffffffffffffffffffffffff19168317905552600201805460ff191690911790555b6001600160a01b0381166000908152600460205260408120805491610a8c83610d9d565b90915550506002546001600160a01b038216600090815260046020526040902054610ab79190610db8565b610bab5760405163d86768e960e01b81526001600160a01b038216600482015260009061c0029063d86768e99060240160206040518083038186803b158015610aff57600080fd5b505afa158015610b13573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b379190610d3c565b9050806001600160a01b031663826d3dec6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610b7457600080fd5b505af1158015610b88573d6000803e3d6000fd5b505050506001600160a01b03821660009081526004602052604081205550610ca8565b6001546001600160a01b038216600090815260046020526040902054610bd19190610db8565b610ca85760405163d86768e960e01b81526001600160a01b038216600482015260009061c0029063d86768e99060240160206040518083038186803b158015610c1957600080fd5b505afa158015610c2d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c519190610d3c565b9050806001600160a01b031663ba26d9ff6040518163ffffffff1660e01b8152600401600060405180830381600087803b158015610c8e57600080fd5b505af1158015610ca2573d6000803e3d6000fd5b50505050505b806001600160a01b03167f770e0cca42c35d00240986ce8d3ed438be04663c91dac6576b79537d7c180f1e42604051610ce391815260200190565b60405180910390a250565b60058181548110610cfe57600080fd5b6000918252602090912001546001600160a01b0316905081565b600060208284031215610d2a57600080fd5b8135610d3581610e24565b9392505050565b600060208284031215610d4e57600080fd5b8151610d3581610e24565b600060208284031215610d6b57600080fd5b5035919050565b600082610d8157610d81610de2565b500490565b600082821015610d9857610d98610dcc565b500390565b6000600019821415610db157610db1610dcc565b5060010190565b600082610dc757610dc7610de2565b500690565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b6001600160a01b038116811461058f57600080fdfea164736f6c6343000807000a"
)

type hardForkPunishV1 struct {
}

func (s *hardForkPunishV1) GetName() string {
	return PunishV1ContractName
}

func (s *hardForkPunishV1) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(punishV1Code)

	//write code to sys contract
	state.SetCode(PunishV1ContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", PunishV1ContractAddr.String(), "code", punishV1Code)

	return
}

func (s *hardForkPunishV1) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	// initialize v1 contract
	method := "initialize"
	data, err := GetInteractiveABI()[s.GetName()].Pack(method)
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &PunishV1ContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, nil, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
