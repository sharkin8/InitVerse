package systemcontract

import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/consensus/parlia/vmcaller"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
	"math"
	"math/big"
)

var (
	govAdmin        = common.HexToAddress("0xce930537a2148b8dc43899ff2e9bcbee0e801c54")
	govAdminTestnet = common.HexToAddress("0xce930537a2148b8dc43899ff2e9bcbee0e801c54")
)

const (
	govCode = "0x608060405234801561001057600080fd5b50600436106101775760003560e01c806371a1bb75116100d8578063e3377eb91161008c578063f851a44011610066578063f851a440146102d1578063fb48270c146102e9578063fbb847e1146102f157600080fd5b8063e3377eb9146102be578063ec0cb33614610228578063f3b1cc671461022857600080fd5b8063c4d66de8116100bd578063c4d66de814610278578063c967f90f1461028b578063e08b1d38146102a657600080fd5b806371a1bb751461025f5780639001eed81461026857600080fd5b8063267822471161012f5780633656de21116101145780633656de211461023057806344f99900146102435780634fb9e9b71461024c57600080fd5b806326782247146101fd5780632e4f67e41461022857600080fd5b8063158ef93e11610160578063158ef93e146101c357806315de360e146101e0578063232e5ffc146101e857600080fd5b806303fab4f61461017c57806305b848101461019e575b600080fd5b61018b670de0b6b3a764000081565b6040519081526020015b60405180910390f35b6101b16101ac366004610efe565b6102f9565b60405161019596959493929190610f24565b6000546101d09060ff1681565b6040519015158152602001610195565b61018b600a81565b6101fb6101f6366004610e3f565b6104a3565b005b600154610210906001600160a01b031681565b6040516001600160a01b039091168152602001610195565b61018b601481565b6101b161023e366004610e3f565b6106b5565b61021061c00381565b6101fb61025a366004610e1d565b610728565b61021061c00281565b61018b6802b5e3af16b188000081565b6101fb610286366004610e1d565b6107be565b610293600f81565b60405161ffff9091168152602001610195565b60035460405163ffffffff9091168152602001610195565b6101fb6102cc366004610e58565b61085a565b6000546102109061010090046001600160a01b031681565b6101fb610bd5565b60025461018b565b600080600080600060606003805490508763ffffffff16106103625760405162461bcd60e51b815260206004820152601260248201527f496e646578206f7574206f662072616e6765000000000000000000000000000060448201526064015b60405180910390fd5b600060038863ffffffff168154811061037d5761037d611043565b60009182526020918290206040805160c08101825260069093029091018054835260018101549383019390935260028301546001600160a01b039081169183019190915260038301541660608201526004820154608082015260058201805491929160a0840191906103ee90610fc1565b80601f016020809104026020016040519081016040528092919081815260200182805461041a90610fc1565b80156104675780601f1061043c57610100808354040283529160200191610467565b820191906000526020600020905b81548152906001019060200180831161044a57829003601f168201915b5050509190925250508151602083015160408401516060850151608086015160a090960151939e929d50909b5099509297509550909350505050565b3341146104f25760405162461bcd60e51b815260206004820152600a60248201527f4d696e6572206f6e6c79000000000000000000000000000000000000000000006044820152606401610359565b60005b6003548110156106b157816003828154811061051357610513611043565b906000526020600020906006020160000154141561069f5760035461053a90600190610faa565b8114610607576003805461055090600190610faa565b8154811061056057610560611043565b90600052602060002090600602016003828154811061058157610581611043565b6000918252602090912082546006909202019081556001808301549082015560028083015490820180546001600160a01b039283166001600160a01b03199182161790915560038085015490840180549190931691161790556004808301549082015560058083018054918301916105f890610fc1565b610603929190610cb0565b5050505b60038054806106185761061861102d565b600082815260208120600660001990930192830201818155600181018290556002810180546001600160a01b03199081169091556003820180549091169055600481018290559061066c6005830182610d3b565b5050905560405182907fc2946e69de813a7cede502a3b315aa221abf9fcca5c7134b0ae6b2c3857cf63d90600090a25050565b806106a981610ffc565b9150506104f5565b5050565b6000806000806000606060028054905087106107135760405162461bcd60e51b815260206004820152601160248201527f496420646f6573206e6f742065786973740000000000000000000000000000006044820152606401610359565b60006002888154811061037d5761037d611043565b60005461010090046001600160a01b031633146107745760405162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b6044820152606401610359565b600180546001600160a01b0319166001600160a01b0383169081179091556040517faefcaa6215f99fe8c2f605dd268ee4d23a5b596bbca026e25ce8446187f4f1ba90600090a250565b60005460ff16156108115760405162461bcd60e51b815260206004820152601360248201527f416c726561647920696e697469616c697a6564000000000000000000000000006044820152606401610359565b6000805460ff196001600160a01b0390931661010002929092167fffffffffffffffffffffff000000000000000000000000000000000000000000909216919091176001179055565b60005461010090046001600160a01b031633146108a65760405162461bcd60e51b815260206004820152600a60248201526941646d696e206f6e6c7960b01b6044820152606401610359565b6002546040805160c08101825282815260208082018a90526001600160a01b03808a168385015288166060830152608082018790528251601f860182900482028101820190935284835260009260a083019187908790819084018382808284376000920182905250939094525050600280546001810182559152825160069091027f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace81019182556020808501517f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5acf83015560408501517f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad0830180546001600160a01b039283166001600160a01b03199182161790915560608701517f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad18501805491909316911617905560808501517f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad283015560a085015180519596508695939450610a58937f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ad390930192910190610d78565b505060038054600181018255600091909152825160069091027fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b81019182556020808501517fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85c83015560408501517fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85d830180546001600160a01b039283166001600160a01b03199182161790915560608701517fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85e8501805491909316911617905560808501517fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85f83015560a08501518051869550610b9d937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f86001929190910190610d78565b50506040518391507f2f28cf6eab3be78ec5322050b7c7ce47adc6f2cf957c0a7b7c6d893fcec891d990600090a25050505050505050565b6001546001600160a01b03163314610c2f5760405162461bcd60e51b815260206004820152600e60248201527f4e65772061646d696e206f6e6c790000000000000000000000000000000000006044820152606401610359565b60018054600080546001600160a01b038084166101009081027fffffffffffffffffffffff0000000000000000000000000000000000000000ff909316929092178084556001600160a01b03199094169094556040519204909216917f7ce7ec0b50378fb6c0186ffb5f48325f6593fcb4ca4386f21861af3129188f5c91a2565b828054610cbc90610fc1565b90600052602060002090601f016020900481019282610cde5760008555610d2b565b82601f10610cef5780548555610d2b565b82800160010185558215610d2b57600052602060002091601f016020900482015b82811115610d2b578254825591600101919060010190610d10565b50610d37929150610dec565b5090565b508054610d4790610fc1565b6000825580601f10610d57575050565b601f016020900490600052602060002090810190610d759190610dec565b50565b828054610d8490610fc1565b90600052602060002090601f016020900481019282610da65760008555610d2b565b82601f10610dbf57805160ff1916838001178555610d2b565b82800160010185558215610d2b579182015b82811115610d2b578251825591602001919060010190610dd1565b5b80821115610d375760008155600101610ded565b80356001600160a01b0381168114610e1857600080fd5b919050565b600060208284031215610e2f57600080fd5b610e3882610e01565b9392505050565b600060208284031215610e5157600080fd5b5035919050565b60008060008060008060a08789031215610e7157600080fd5b86359550610e8160208801610e01565b9450610e8f60408801610e01565b935060608701359250608087013567ffffffffffffffff80821115610eb357600080fd5b818901915089601f830112610ec757600080fd5b813581811115610ed657600080fd5b8a6020828501011115610ee857600080fd5b6020830194508093505050509295509295509295565b600060208284031215610f1057600080fd5b813563ffffffff81168114610e3857600080fd5b8681526000602087818401526001600160a01b03808816604085015280871660608501525084608084015260c060a084015283518060c085015260005b81811015610f7d5785810183015185820160e001528201610f61565b81811115610f8f57600060e083870101525b50601f01601f19169290920160e00198975050505050505050565b600082821015610fbc57610fbc611017565b500390565b600181811c90821680610fd557607f821691505b60208210811415610ff657634e487b7160e01b600052602260045260246000fd5b50919050565b600060001982141561101057611010611017565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603160045260246000fd5b634e487b7160e01b600052603260045260246000fdfea164736f6c6343000807000a"
)

type hardForkSysGov struct {
}

func (s *hardForkSysGov) GetName() string {
	return SysGovContractName
}

func (s *hardForkSysGov) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	contractCode := common.FromHex(govCode)

	//write govCode to sys contract
	state.SetCode(SysGovContractAddr, contractCode)
	log.Debug("Write code to system contract account", "addr", SysGovContractAddr.String(), "code", govCode)

	return
}

func (s *hardForkSysGov) getAdminByChainId(chainId *big.Int) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.ChainID) == 0 {
		return govAdmin
	}

	return govAdminTestnet
}

func (s *hardForkSysGov) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {

	method := "initialize"
	data, err := GetInteractiveABI()[SysGovContractName].Pack(method, s.getAdminByChainId(config.ChainID))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := types.NewMessage(header.Coinbase, &SysGovContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, nil, false)
	vmcaller.ExecuteMsg(msg, state, header, chainContext, config)
	//context := core.NewEVMContext(msg, header, chainContext, nil)
	//evm := vm.NewEVM(context, state, config, vm.Config{})
	//
	//_, _, err = evm.Call(vm.AccountRef(msg.From()), *msg.To(), msg.Data(), msg.Gas(), msg.Value())

	return
}
